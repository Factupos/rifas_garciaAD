<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <title>Pagina</title>
  <link rel="icon" href="data:,">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, interactive-widget=overlays-content">
  <!-- Performance -->
  <link rel="preconnect" href="https://docs.google.com" crossorigin>
  <link rel="preconnect" href="https://csv-proxy.jeisendigital.workers.dev" crossorigin>

  <style>
/* ====== BASE UI (ligero y veloz) ====== */
/* ====== PREMIUM MARKETING UI (Suerte, Regalos & VIP) ====== */
:root {
  /* ====== THEME: Vibrante, Alegre y Lujoso ====== */
  --brand-1: #FFD700; /* Oro Brillante */
  --brand-2: #00F5D4; /* Cyan El√©ctrico */
  --brand-3: #F15BB5; /* Magenta Vivo */

  /* Fondo Negro Puro y Est√°tico */
  --bg-solid: #000000;
  --bg-grad: radial-gradient(circle at 50% 0%, #1a1a1a 0%, #000000 70%);

  --ink: #FFFFFF;
  --muted: rgba(255, 255, 255, 0.75);

  --panel: rgba(255, 255, 255, 0.05);
  --panel-strong: rgba(255, 255, 255, 0.09);
  --panel-border: rgba(255, 255, 255, 0.15);
  --shadow: rgba(0, 0, 0, 0.6);

  --header-h: 90px; --vv-top: 0px; --extra-top: 0px;
  --sat: env(safe-area-inset-top, 0px);
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
html, body { height: 100%; }
html { overflow-anchor: none; }
body {
  margin: 0; font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  color: var(--ink); 
  background: var(--bg-solid); 
  background-image: var(--bg-grad);
  background-attachment: fixed; /* üî• ESTO HACE QUE EL FONDO NO HAGA SCROLL */
  background-size: cover;
  background-repeat: no-repeat;
  -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
  line-height: 1.2;
  padding-top: calc(var(--header-h) + var(--sat) + var(--vv-top) + var(--extra-top));
  overscroll-behavior-y: contain; touch-action: manipulation;
}

/* Velo de lectura superior */
.top-veil {
  position: fixed; left: 0; right: 0; top: 0; z-index: 25; pointer-events: none;
  height: calc(var(--header-h) + var(--sat) + var(--extra-top) + 16px);
  transform: translateY(var(--vv-top));
  background: linear-gradient(180deg, rgba(9,5,20,0.95) 0%, rgba(9,5,20,0.7) 40%, rgba(9,5,20,0) 100%);
  will-change: transform;
}

header {
  position: fixed; left: 0; right: 0; z-index: 30; 
  top: calc(var(--sat) + var(--vv-top) + var(--extra-top)) !important;
  display: flex; align-items: center; gap: 10px; flex-wrap: wrap;
  padding: 10px 14px; min-height: 90px;
  background: rgba(15, 10, 30, 0.65); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
  border-bottom: 1px solid rgba(255, 255, 255, 0.08);
  box-shadow: 0 10px 30px rgba(0,0,0,0.5); transform: translateZ(0);
}

.brand { display: flex; align-items: center; gap: 14px; }

/* ====== LOGO ANIMADO (Premium & Joyful) ====== */
.logoWrap {
  position: relative; width: 56px; height: 56px;
  border-radius: 16px; flex: 0 0 auto;
  z-index: 1;
}

/* Aro Externo (Blanco Puro con resplandor) */
.logoWrap::before {
  content: ""; position: absolute; inset: -6px; border-radius: 22px; padding: 2px;
  background: conic-gradient(from 0deg, #ffffff 0%, rgba(255,255,255,0) 25%, #ffffff 50%, rgba(255,255,255,0) 75%, #ffffff 100%);
  -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
  -webkit-mask-composite: xor; mask-composite: exclude;
  animation: spinRight 3s linear infinite;
  pointer-events: none;
  filter: drop-shadow(0 0 6px rgba(255,255,255,0.6));
}

/* Aro Interno (Gris Plata / Grafito) para dar efecto de entrelazado 3D */
.logoWrap::after {
  content: ""; position: absolute; inset: -3px; border-radius: 19px; padding: 2px;
  background: conic-gradient(from 45deg, rgba(0,0,0,0.8) 0%, #a0a0a0 25%, rgba(0,0,0,0.8) 50%, #ffffff 75%, rgba(0,0,0,0.8) 100%);
  -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
  -webkit-mask-composite: xor; mask-composite: exclude;
  animation: spinLeft 4s linear infinite;
  pointer-events: none;
}

.logoWrap img {
  width: 100%; height: 100%; object-fit: cover; border-radius: 14px;
  border: 1px solid rgba(255,255,255,0.3);
  box-shadow: 0 4px 15px rgba(0,0,0,0.9);
  position: relative; z-index: 2;
}

@keyframes spinRight { to { transform: rotate(360deg); } }
@keyframes spinLeft { to { transform: rotate(-360deg); } }

/* Texto de la marca: Puro y Elegante */
.brand h1 {
  margin: 0; display: inline-block; font-weight: 900;
  font-size: clamp(22px, 3.8vw, 28px); letter-spacing: 0.5px;
  color: #FFFFFF; text-transform: uppercase;
  text-shadow: 0 2px 10px rgba(255, 255, 255, 0.3);
}

/* Buscador interactivo */
.search-bar {
  flex: 1 1 320px; height: 52px; border-radius: 14px;
  border: 1px solid var(--panel-border); padding: 0 16px; font-size: 18px;
  outline: none; background: rgba(0,0,0,0.3); color: var(--ink);
  box-shadow: inset 0 2px 5px rgba(0,0,0,0.5);
  transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
}
.search-bar::placeholder { color: rgba(255,255,255,0.5); }
.search-bar:focus {
  background: rgba(255,255,255,0.08); border-color: var(--brand-2);
  box-shadow: 0 0 0 3px rgba(0, 245, 212, 0.15), inset 0 0 10px rgba(0, 245, 212, 0.1);
}

/* ====== BOT√ìN ALEATORIO (CTA Marketinero) ====== */
.random-button {
  height: 52px; border-radius: 14px; padding: 0 24px;
  font-weight: 800; font-size: 15px; letter-spacing: 0.5px; border: none; cursor: pointer;
  color: #111; text-transform: uppercase;
  background: linear-gradient(90deg, #FFD700, #FFF5B8, #FFD700);
  background-size: 200% auto;
  box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3), inset 0 -2px 0 rgba(0,0,0,0.1);
  animation: shineCTA 3s linear infinite;
  transition: transform 0.2s, box-shadow 0.2s;
}
.random-button:active { transform: scale(0.95) translateY(2px); box-shadow: 0 2px 5px rgba(255, 215, 0, 0.3); }
@keyframes shineCTA { to { background-position: 200% center; } }

.contact-info { display: flex; align-items: center; gap: 12px; margin-left: auto; }
.contact-info p { margin: 0; font-size: 12px; color: var(--brand-2); font-weight: 600; }

.finish-top-button {
  height: 42px; min-height: 42px; border-radius: 12px; padding: 0 20px;
  font-size: 13px; font-weight: 800; letter-spacing: 0.5px;
  text-transform: uppercase; border: none; cursor: pointer;
  color: #fff; background: linear-gradient(135deg, var(--brand-3), #C1126F);
  box-shadow: 0 4px 15px rgba(241, 91, 181, 0.4);
  display: none; flex-shrink: 0; align-items: center; justify-content: center;
}

.search-result {
  position: fixed; top: calc(var(--sat) + var(--vv-top) + var(--extra-top) + var(--header-h) + 16px);
  left: 50%; transform: translateX(-50%); z-index: 55;
  display: none; width: min(92vw, 720px);
  pointer-events: auto; justify-content: center; gap: 12px;
}
body.search-has-text #raffles { display: none !important; }
#raffles {
  display: flex; flex-wrap: wrap; justify-content: center; gap: 12px;
  margin: 20px auto 40px; max-width: 1240px; padding: 0 10px 20vh;
}

/* ====== CARRITO ====== */
.cart-panel {
  display: none; flex: 0 0 100%; margin-top: 10px;
  padding: 10px 14px; border-radius: 14px;
  background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.1);
  box-shadow: inset 0 2px 10px rgba(0,0,0,0.5);
  display: flex; align-items: center; gap: 12px;
}
.cart-label {
  font-size: 11px; font-weight: 700; text-transform: uppercase;
  letter-spacing: 1px; color: var(--brand-1);
}
.cart-strip {
  display: flex; gap: 10px; flex: 1; overflow-x: auto;
  padding-bottom: 4px; scroll-snap-type: x mandatory;
}
.cart-item {
  flex: 0 0 auto; min-width: 64px; padding: 8px 12px; border-radius: 10px;
  background: linear-gradient(135deg, var(--brand-1), #FDB931); color: #111;
  box-shadow: 0 4px 10px rgba(255, 215, 0, 0.3);
  display: flex; align-items: center; justify-content: center; gap: 8px;
  scroll-snap-align: start; font-weight: 800;
}
.cart-item-num { font-size: 16px; text-shadow: 0 1px 2px rgba(255,255,255,0.5); }
.cart-item-remove {
  border: none; outline: none; cursor: pointer;
  width: 22px; height: 22px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 15px; font-weight: 700;
  background: rgba(0,0,0,0.15); color: #000; padding: 0; transition: background 0.2s;
}
.cart-item-remove:active { background: rgba(0,0,0,0.3); }

/* ====== TILES (BOLETAS M√ÅGICAS) ====== */
.raffle {
  --size: clamp(84px, 25vw, 114px);
  width: var(--size); height: calc(var(--size) + 12px);
  border-radius: 16px; display: flex; align-items: center; justify-content: center;
  position: relative; outline: none; cursor: pointer; transform: translateZ(0);
  background: rgba(255, 255, 255, 0.04);
  border: 1px solid rgba(255, 255, 255, 0.08);
  box-shadow: 0 8px 20px rgba(0,0,0,0.3), inset 0 2px 10px rgba(255,255,255,0.02);
  transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1), box-shadow 0.3s, background 0.3s;
}

/* El brillo puro de los n√∫meros INCLUSO sin hover */
.raffle .num {
  position: relative; z-index: 2; font-size: clamp(34px, 7.5vw, 44px);
  font-weight: 800; color: #FFFFFF; line-height: 1;
  text-shadow: 
    0 2px 4px rgba(0,0,0,0.8), 
    0 0 12px rgba(255,255,255,0.4), 
    0 0 22px rgba(255,255,255,0.2);
  transition: text-shadow 0.3s ease, color 0.3s ease;
}

/* Hover Suave Desktop */
@media (hover: hover) {
  .raffle:hover:not(.selected) {
    background: rgba(255, 255, 255, 0.08);
    transform: translateY(-2px);
    box-shadow: 0 12px 25px rgba(0,0,0,0.4), inset 0 2px 15px rgba(255,255,255,0.05);
  }
  .raffle:hover:not(.selected) .num {
    text-shadow: 0 2px 4px rgba(0,0,0,0.8), 0 0 15px rgba(255,255,255,0.7), 0 0 30px rgba(255,255,255,0.4);
  }
}

/* ====== ESTADO SELECCIONADO (GANADOR/VIP) ====== */
.raffle .tick {
  position: absolute; top: 8px; right: 8px;
  width: 22px; height: 22px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 13px; font-weight: 900;
  background: var(--brand-1); color: #000;
  opacity: 0; transform: scale(0.5);
  transition: all 0.25s cubic-bezier(0.2, 0.8, 0.2, 1);
  z-index: 3; pointer-events: none;
  box-shadow: 0 0 10px var(--brand-1);
}
.raffle.selected {
  background: rgba(255, 215, 0, 0.12); /* Brillo oro interior */
  border-color: rgba(255, 215, 0, 0.5);
  transform: translateY(-4px) scale(1.03);
  box-shadow: 
    0 15px 30px rgba(0,0,0,0.6), 
    0 0 20px rgba(255, 215, 0, 0.2),
    inset 0 0 15px rgba(255, 215, 0, 0.1);
}
.raffle.selected .tick { opacity: 1; transform: scale(1); }
.raffle.selected .num {
  color: #FFF;
  text-shadow: 0 2px 4px rgba(0,0,0,0.6), 0 0 15px var(--brand-1), 0 0 30px var(--brand-1);
}

.large-raffle { --size: clamp(140px, 45vw, 190px); width: var(--size); height: calc(var(--size) + 16px); }
.large-raffle .num { font-size: clamp(48px, 11vw, 65px); }

/* ====== MENSAJES FLOTANTES ====== */
.message {
  padding: 16px 24px; background: rgba(0, 0, 0, 0.85); color: #fff;
  border: 1px solid var(--brand-2); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
  border-radius: 14px; width: min(92vw, 400px); text-align: center;
  font-size: 16px; font-weight: 700; display: none !important;
  position: fixed; top: calc(var(--sat) + var(--vv-top) + var(--extra-top) + var(--header-h) + 16px);
  left: 50%; transform: translateX(-50%); z-index: 60;
  box-shadow: 0 10px 40px rgba(0,245,212,0.2);
}
.message.error { border-color: #FF3B30; box-shadow: 0 10px 40px rgba(255,59,48,0.2); }

.loading-message {
  position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
  background: rgba(10,5,25,0.9); color: #fff; border: 1px solid rgba(255,255,255,0.1);
  backdrop-filter: blur(12px); border-radius: 16px; padding: 20px 24px;
  text-align: center; font-size: 18px; font-weight: 600;
  display: none; box-shadow: 0 20px 50px rgba(0,0,0,0.8); z-index: 40;
}

/* ====== OVERLAY Y DI√ÅLOGOS (Flujo de compra) ====== */
.ov {
  position: fixed; inset: 0; background: rgba(0,0,0,0.7);
  backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
  z-index: 9000; display: none; align-items: center; justify-content: center;
}
.ov.show { display: flex; }
.box {
  display: block; min-width: min(92vw, 420px); max-width: 92vw;
  background: linear-gradient(180deg, #1A122B, #0D0814); border-radius: 20px; 
  border: 1px solid rgba(255,255,255,0.1);
  box-shadow: 0 24px 60px rgba(0,0,0,0.8), inset 0 2px 10px rgba(255,255,255,0.05); 
  padding: 24px 20px; text-align: center; transform-origin: center center;
}
.q { margin: 0 0 18px 0; font-size: 20px; font-weight: 700; color: #fff; }
.actions { display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; }
.btn {
  font-weight: 800; border: none; border-radius: 12px; padding: 14px 20px;
  cursor: pointer; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;
  transition: transform 0.2s, opacity 0.2s;
}
.btn:active { transform: scale(0.96); opacity: 0.8; }
.btn.ok { background: linear-gradient(90deg, var(--brand-1), #FFF5B8); color: #111; box-shadow: 0 4px 15px rgba(255,215,0,0.2); }
.btn.no { background: rgba(255,255,255,0.05); color: #fff; border: 1px solid rgba(255,255,255,0.15); }

/* ====== BOOT / PANTALLA DE CARGA ====== */
.boot {
  position: fixed; inset: 0; z-index: 99999; display: none;
  align-items: center; justify-content: center; padding: 20px;
  background: var(--bg-solid); background-image: var(--bg-grad); color: #fff;
}
.boot.show { display: flex; }
.bootCard {
  width: min(480px, 92vw); border-radius: 20px; padding: 30px;
  background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.05);
  box-shadow: 0 30px 60px rgba(0,0,0,0.8); text-align: center;
  backdrop-filter: blur(10px);
}
.bootTop { display: flex; flex-direction: column; align-items: center; gap: 16px; }
.bootLogo {
  width: 76px; height: 76px; border-radius: 18px;
  background: rgba(255,255,255,0.05); padding: 3px;
  border: 1px solid rgba(255,255,255,0.15);
  box-shadow: 0 10px 25px rgba(0,0,0,0.5);
}
.bootLogo img { width: 100%; height: 100%; object-fit: cover; border-radius: 14px; }
.bootTitle { margin: 0; font-weight: 800; font-size: 24px; color: #fff; text-shadow: 0 2px 10px rgba(255,255,255,0.2); }
.bootSub { margin: 6px 0 0 0; font-size: 14px; color: var(--muted); font-weight: 500; }

.bootMeter {
  margin-top: 28px; height: 6px; border-radius: 3px;
  background: rgba(255,255,255,0.1); overflow: hidden; position: relative;
}
.bootBar {
  height: 100%; width: 0%; 
  background: linear-gradient(90deg, var(--brand-1), var(--brand-3));
  box-shadow: 0 0 10px var(--brand-1);
  transition: width 0.4s cubic-bezier(0.2, 1, 0.2, 1);
}
.bootMsg { margin: 20px 0 0; font-size: 14px; font-weight: 600; color: #bbb; }
.bootHint { margin: 12px 0 0; font-size: 12px; color: rgba(255,255,255,0.4); font-weight: 400; }
.boot.hide { animation: bootFadeOut 0.4s ease forwards; }
@keyframes bootFadeOut { to { opacity: 0; transform: translateY(10px); visibility: hidden; } }

/* ====== PANTALLA BLOQUEADA ====== */
.blocked {
  position: fixed; inset: 0; z-index: 99998; display: none;
  align-items: center; justify-content: center; padding: 20px;
  background: #090514;
}
.blocked.show { display: flex; }
.blockCard {
  width: min(520px, 92vw); border-radius: 20px; padding: 30px 24px;
  background: linear-gradient(180deg, #150E22, #090514); border: 1px solid rgba(255,255,255,0.08);
  box-shadow: 0 30px 60px rgba(0,0,0,0.8); text-align: center;
}
.blockBadge {
  display: inline-flex; align-items: center; gap: 8px; padding: 8px 14px;
  border-radius: 8px; background: rgba(255, 59, 48, 0.15); color: #FF3B30;
  font-weight: 700; font-size: 12px; text-transform: uppercase; letter-spacing: 1px;
}
.blockTitle { margin: 20px 0 10px; font-size: 24px; font-weight: 800; color: #fff; }
.blockText { margin: 0 auto; color: var(--muted); font-size: 15px; line-height: 1.5; }
.blockMini { margin-top: 20px; display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; }
.miniChip {
  padding: 8px 14px; border-radius: 10px; font-size: 13px; color: #ddd; font-weight: 600;
  border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05);
}
.blockActions { margin-top: 26px; display: flex; gap: 12px; justify-content: center; }
.blockBtn {
  border: none; border-radius: 12px; padding: 14px 22px; cursor: pointer;
  font-weight: 700; font-size: 14px; text-transform: uppercase;
  background: linear-gradient(90deg, var(--brand-1), #FFF5B8); color: #111;
}
.blockBtn.secondary { background: rgba(255,255,255,0.05); color: #fff; border: 1px solid rgba(255,255,255,0.2); }

/* ====== MODAL CHECKOUT ====== */
.modal-backdrop {
  position: fixed; inset: 0; display: none; 
  align-items: center; /* üî• ESTA ES LA MAGIA: Centrado absoluto siempre */
  justify-content: center;
  background: rgba(0,0,0,0.85); z-index: 9999; padding: 20px; 
  backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
}

.modal {
  width: min(500px, 100%); border-radius: 24px; overflow: hidden;
  background: linear-gradient(180deg, #1A122B, #0D0814); 
  border: 1px solid rgba(255,255,255,0.1);
  box-shadow: 0 30px 80px rgba(0,0,0,0.9), inset 0 2px 10px rgba(255,255,255,0.05);
  /* Animaci√≥n de entrada VIP */
  animation: modalPopUp 0.3s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
  transform: scale(0.95); opacity: 0;
}

@keyframes modalPopUp {
  to { transform: scale(1); opacity: 1; }
}

.modal-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 24px; border-bottom: 1px solid rgba(255,255,255,0.05);
}
.modal-header h3 { margin: 0; font-size: 18px; font-weight: 800; color: #fff; letter-spacing: 0.5px; }
.modal-close {
  appearance: none; border: none; cursor: pointer;
  width: 36px; height: 36px; border-radius: 50%;
  background: rgba(255,255,255,0.08); color: #fff; font-weight: 600; font-size: 16px;
  transition: background 0.2s, transform 0.2s;
}
.modal-close:hover { background: rgba(255,255,255,0.15); transform: scale(1.05); }
.modal-close:active { transform: scale(0.95); }

.modal-body { padding: 24px; }
.modal-body p { margin: 0 0 20px 0; color: var(--muted); font-size: 14px; font-weight: 500; }
.form-row { display: flex; flex-direction: column; gap: 8px; margin-bottom: 18px; }
.form-row label { font-size: 13px; color: var(--brand-2); font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
.form-row input {
  height: 52px; border-radius: 12px; padding: 0 16px; font-size: 16px; font-weight: 500;
  border: 1px solid rgba(255,255,255,0.15); background: rgba(0,0,0,0.3);
  color: #fff; outline: none; transition: border 0.2s, box-shadow 0.2s;
}
.form-row input:focus { border-color: var(--brand-2); box-shadow: 0 0 0 3px rgba(0, 245, 212, 0.15); }

.modal-actions { display: flex; gap: 12px; padding: 0 24px 24px; }
.btn-primary { background: linear-gradient(90deg, var(--brand-1), #FFF5B8); color: #111; box-shadow: 0 4px 15px rgba(255,215,0,0.2); }
.btn-secondary { background: rgba(255,255,255,0.05); color: #fff; border: 1px solid rgba(255,255,255,0.1); }
.modal-small { font-size: 12px; color: #888; margin-top: 6px; }

/* Pantalla final loading */
.loading-screen {
  position: fixed; inset: 0; display: none; align-items: center; justify-content: center;
  background: rgba(0,0,0,0.85); z-index: 10000; padding: 20px; text-align: center;
  backdrop-filter: blur(12px);
}
.loading-card {
  width: min(420px, 100%); border-radius: 20px; padding: 32px;
  background: linear-gradient(180deg, #1A122B, #0D0814); border: 1px solid rgba(255,255,255,0.1);
  box-shadow: 0 30px 80px rgba(0,0,0,0.9);
}
.loading-card h4 { margin: 0 0 12px 0; font-size: 20px; color: #fff; font-weight: 800; }
.loading-card p { margin: 0; color: var(--muted); font-size: 15px; }

@media(max-width:768px){
  header { padding: 12px 14px; }
  .contact-info { width: 100%; justify-content: space-between; margin-top: 4px; }
  .search-bar, .random-button { width: 100%; }
}
@media(prefers-reduced-motion:reduce){*,*::before,*::after{animation:none !important;transition:none !important}}

</style>

</head>

<body>
  <div class="top-veil" aria-hidden="true"></div>

  <!-- BOOT (pantalla de carga) -->
  <div id="boot" class="boot show" aria-live="polite" aria-busy="true">
    <div class="bootCard">
      <div class="bootTop">
        <div class="bootLogo" aria-hidden="true">
          <img id="bootLogoImg" src="" alt="" referrerpolicy="no-referrer">
        </div>
        <div>
          <p id="bootTitle" class="bootTitle">Cargando‚Ä¶</p>
          <p id="bootSub" class="bootSub">Preparando boletas y verificaci√≥n de estado</p>
        </div>
      </div>
      <div class="bootMeter" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="10">
        <div id="bootBar" class="bootBar"></div>
        <div class="bootGlow" aria-hidden="true"></div>
      </div>
      <p class="bootMsg"><span class="dotPulse" aria-hidden="true"></span> <span id="bootMsgTxt">Iniciando‚Ä¶</span></p>
      <p class="bootHint" id="bootHint">Tip: en celular puedes escribir el n√∫mero directo y se muestra solo la boleta.</p>
    </div>
  </div>

  <!-- BLOQUEADO (si Configuracion!X2 = TRUE) -->
  <div id="blocked" class="blocked" aria-live="polite">
    <div class="blockCard">
      <div class="blockBadge"><i></i> Sistema inhabilitado</div>
      <div class="blockTitle" id="blockedTitle">Esta p√°gina est√° temporalmente inhabilitada</div>
      <p class="blockText" id="blockedText">
        En este momento el acceso est√° restringido. Por favor intenta m√°s tarde o contacta al administrador.
      </p>
      <div class="blockMini">
        <div class="miniChip" id="blockedName">Rifas</div>
        <div class="miniChip" id="blockedPhone"></div>
        <div class="miniChip" id="blockedAddr"></div>
      </div>
      <div class="blockActions">
        <button class="blockBtn" id="blockedWhatsApp" type="button">Contactar por WhatsApp</button>
        <button class="blockBtn secondary" id="blockedRetry" type="button">Reintentar</button>
      </div>
    </div>
  </div>

  <header>
    <div class="brand">
      <div class="logoWrap"><img id="logoImg" src="" alt="Logo" referrerpolicy="no-referrer"></div>
      <h1 id="houseName">Rifas</h1>
    </div>
    <input id="search" class="search-bar" type="tel" inputmode="numeric" pattern="[0-9]*" maxlength="4" enterkeyhint="search" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Buscar # de boleta‚Ä¶">
    <button class="random-button" id="randomButton"># ALEATORIO</button>
    <div class="contact-info"><p id="phone"></p><p id="address"></p></div>
    <!-- Bot√≥n Finalizar (carrito activo) -->
    <button id="finishTop" class="finish-top-button" type="button">Finalizar</button>
    <!-- Carrito -->
    <div id="cartPanel" class="cart-panel" aria-live="polite"></div>
  </header>

  <div id="searchResult" class="search-result"></div>
  <div id="raffles" aria-live="polite"></div>

  <!-- Overlay + Modal -->
  <div id="ov" class="ov" aria-hidden="true">
    <div id="box" class="box" role="dialog" aria-modal="true">
      <p id="q" class="q"></p>
      <div class="actions">
        <button id="yes" class="btn ok" type="button">S√≠</button>
        <button id="keep" class="btn ok" type="button">Seguir separando</button>
        <button id="no" class="btn no" type="button">No</button>
      </div>
    </div>
  </div>

  <!-- Mensajes -->
  <div id="message" class="message">Boleta ocupada</div>
  <div id="loadingMessage" class="loading-message">Buscando n√∫mero aleatorio...</div>

  <script>
  const APPS_SCRIPT_WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbz522NWZJc4hjtuRNObFA77rW2zw7Kj43YhCGwRB2yhV6M6vwn2EeLjvbI7xmjCzyfmwQ/exec';

/* =========================================================
   ‚úÖ CONFIG (VISIBLES AL INICIO ‚Äî como pediste)
   ========================================================= */
const KEY = '1hcHnj9HEZfEpLlp_WWj8d5a8-69ODelEugMjYg1UN6I';
const GID_RAFFLES = '1661661343';   // A: N√∫mero, B: Libre/Asignado
const GID_CONFIG  = '1977832725';    // Config_Publica
const GID_NOTIFICATIONS = '662101636'; // Notificaciones (logo)
const PROXY = 'https://csv-proxy.jeisendigital.workers.dev/?u=';

/* =========================================================
   ‚úÖ LECTURAS ESPECIALES
   - Bloqueo: Configuracion!X2  (TRUE/FALSE)
   - Logo: Notificaciones!D2 (por defecto)
   ========================================================= */
const BLOCK_SHEET_NAME = 'Configuracion';
const WA_SHEET_NAME = 'Configuracion';
const WA_CELL_RANGE  = 'L2:L2';   // ‚úÖ √öNICO WhatsApp permitido (Configuracion!L2)

const BLOCK_CELL_RANGE = 'X2:X2';
const LOGO_CELL_RANGE  = 'D2:D2';   // ‚Üê si tu logo est√° en otra fila, cambia aqu√≠ (ej: D3:D3)

/* =========================
   RENDIMIENTO: cach√© local (AISLADO por p√°gina/hoja)
   ========================= */
const CACHE_TTL_MS = 10 * 60 * 1000; // 10 min

// Namespace √∫nico por p√°gina + spreadsheet + gids (evita mezclar cach√© entre p√°ginas)
const CACHE_NS = (() => {
  const base = `${location.origin}${location.pathname}|${KEY}|${GID_RAFFLES}|${GID_CONFIG}|${GID_NOTIFICATIONS}`;
  let h = 2166136261; // FNV-1a
  for (let i = 0; i < base.length; i++) {
    h ^= base.charCodeAt(i);
    h = Math.imul(h, 16777619);
  }
  return `raffle_${(h >>> 0).toString(16)}`;
})();

// Metadatos para validar que un cach√© corresponde a esta misma p√°gina/hoja
const CACHE_META = Object.freeze({
  KEY,
  GID_RAFFLES,
  GID_CONFIG,
  GID_NOTIFICATIONS,
  path: location.pathname
});

const MAP_CACHE_KEY   = `${CACHE_NS}_map_v3`;
const CONF_CACHE_KEY  = `${CACHE_NS}_conf_v1`;
const LOGO_CACHE_KEY  = `${CACHE_NS}_logo_v1`;
const BLOCK_CACHE_KEY = `${CACHE_NS}_block_v1`;

// Daily tambi√©n debe ser por p√°gina (no solo por fecha)
function dailyKey(){ return `${CACHE_NS}_daily_${todayKey()}`; }

function cacheMetaOK(meta){
  return !!meta && meta.KEY===KEY && meta.GID_RAFFLES===GID_RAFFLES && meta.GID_CONFIG===GID_CONFIG && meta.GID_NOTIFICATIONS===GID_NOTIFICATIONS && meta.path===location.pathname;
}


function saveMapCache(freeList){
  try{
    localStorage.setItem(
      MAP_CACHE_KEY,
      JSON.stringify({ ts: Date.now(), meta: CACHE_META, freeList })
    );
  }catch(_){}
}
function loadMapCache(){
  try{
    const raw = localStorage.getItem(MAP_CACHE_KEY);
    if(!raw) return null;

    const { ts, meta, freeList } = JSON.parse(raw);
    if(!cacheMetaOK(meta)) return null;
    if(!Array.isArray(freeList)) return null;

    if(Date.now() - ts > CACHE_TTL_MS) return { freeList, stale: true };
    return { freeList, stale: false };
  }catch(_){
    return null;
  }
}
function saveConfCache(conf){
  try{
    localStorage.setItem(
      CONF_CACHE_KEY,
      JSON.stringify({ ts: Date.now(), meta: CACHE_META, conf })
    );
  }catch(_){}
}
function loadConfCache(){
  try{
    const raw = localStorage.getItem(CONF_CACHE_KEY);
    if(!raw) return null;

    const { ts, meta, conf } = JSON.parse(raw);
    if(!cacheMetaOK(meta)) return null;
    if(!conf) return null;

    return { conf, stale: (Date.now() - ts) > CACHE_TTL_MS };
  }catch(_){
    return null;
  }
}
function saveLogoCache(logo){
  try{
    localStorage.setItem(
      LOGO_CACHE_KEY,
      JSON.stringify({ ts: Date.now(), meta: CACHE_META, logo })
    );
  }catch(_){}
}
function loadLogoCache(){
  try{
    const raw = localStorage.getItem(LOGO_CACHE_KEY);
    if(!raw) return null;

    const { ts, meta, logo } = JSON.parse(raw);
    if(!cacheMetaOK(meta)) return null;
    if(!logo) return null;

    return { logo, stale: (Date.now() - ts) > CACHE_TTL_MS };
  }catch(_){
    return null;
  }
}
function saveBlockCache(isBlocked){
  try{
    localStorage.setItem(
      BLOCK_CACHE_KEY,
      JSON.stringify({ ts: Date.now(), meta: CACHE_META, isBlocked: !!isBlocked })
    );
  }catch(_){}
}
function loadBlockCache(){
  try{
    const raw = localStorage.getItem(BLOCK_CACHE_KEY);
    if(!raw) return null;

    const { ts, meta, isBlocked } = JSON.parse(raw);
    if(!cacheMetaOK(meta)) return null;
    if(typeof isBlocked !== 'boolean') return null;

    return { isBlocked, stale: (Date.now() - ts) > (2 * 60 * 1000) }; // 2 min
  }catch(_){
    return null;
  }
}

/* =========================
   BOOT UI (loading pro)
   ========================= */
function bootSet(pct, msg, sub){
  const boot = document.getElementById('boot');
  const bar = document.getElementById('bootBar');
  const m = document.getElementById('bootMsgTxt');
  const s = document.getElementById('bootSub');
  const title = document.getElementById('bootTitle');
  if(!boot || !bar || !m) return;
  const clamped = Math.max(2, Math.min(100, Math.round(pct||0)));
  bar.style.width = clamped + '%';
  boot.querySelector('.bootMeter')?.setAttribute('aria-valuenow', String(clamped));
  if(title && clamped >= 90) title.textContent = '¬°Listo!';
  if(msg) m.textContent = msg;
  if(sub && s) s.textContent = sub;
}
function bootHide(){
  const boot = document.getElementById('boot');
  if(!boot) return;
  boot.classList.add('hide');
  setTimeout(()=>{ boot.classList.remove('show'); boot.setAttribute('aria-busy','false'); }, 450);
}
function bootShow(){
  const boot = document.getElementById('boot');
  if(!boot) return;
  boot.classList.add('show');
  boot.classList.remove('hide');
  boot.setAttribute('aria-busy','true');
}
function showBlockedScreen(reasonText){
  // Oculta boot y muestra bloqueado (sin cargar app)
  const boot = document.getElementById('boot');
  if(boot) boot.classList.remove('show');

  const blk = document.getElementById('blocked');
  if(!blk) return;
  blk.classList.add('show');

  // Completar info si existe config
  const n = (window.__CONFIG_NAME || 'Rifas').trim();
  const pr = (window.__CONFIG_PHONE || '').trim();
  const ad = (window.__CONFIG_ADDR || '').trim();

  const bn = document.getElementById('blockedName');
  const bp = document.getElementById('blockedPhone');
  const ba = document.getElementById('blockedAddr');
  if(bn) bn.textContent = n || 'Rifas';
  if(bp) bp.textContent = pr ? ('Tel: ' + pr) : 'Tel: ‚Äî';
  if(ba) ba.textContent = ad ? ('Dir: ' + ad) : 'Dir: ‚Äî';

  const bt = document.getElementById('blockedText');
  if(bt) bt.textContent = reasonText || 'En este momento el acceso est√° restringido.';

  // WhatsApp
  const btnWA = document.getElementById('blockedWhatsApp');
  if(btnWA){
    // Si no hay WhatsApp validado, no permitir abrir enlace
    const telReady = (window.__WHATSAPP_DIGITS || window.__CONFIG_PHONE_DIGITS || '').trim();
    if(!telReady){
      btnWA.disabled = true;
      btnWA.style.opacity = '0.6';
      btnWA.style.cursor = 'not-allowed';
      btnWA.textContent = 'WhatsApp no configurado';
    }
    btnWA.onclick = ()=>{
      try{
        const tel = window.__WHATSAPP_DIGITS || window.__CONFIG_PHONE_DIGITS || '';
        const msg = 'Hola, intento ingresar pero la p√°gina est√° inhabilitada. ¬øMe puedes ayudar?';
        if(!tel) return; const url = 'https://wa.me/' + tel + '?text=' + encodeURIComponent(msg);
        const w = window.open(url, '_blank');
        if(!w) location.href = url;
      }catch(_){}
    };
  }

  // Reintentar (recarga)
  const retry = document.getElementById('blockedRetry');
  if(retry){
    retry.onclick = ()=> location.reload();
  }
}

/* =========================
   FETCH optimizado (parallel + timeout)
   ========================= */
const csvUrls = (gid) => {
  const ts = Date.now();
  return [
    `https://docs.google.com/spreadsheets/d/${KEY}/export?format=csv&gid=${gid}&_=${ts}`,
    `https://docs.google.com/spreadsheets/d/${KEY}/gviz/tq?tqx=out:csv&gid=${gid}&_=${ts}`
  ];
};
function fetchWithTimeout(url, timeout=6000){
  const ctrl = new AbortController();
  const to = setTimeout(()=>ctrl.abort(), timeout);
  return fetch(PROXY + encodeURIComponent(url), {signal:ctrl.signal, cache:'no-store', credentials:'omit'})
    .then(r=>{clearTimeout(to); if(!r.ok) throw new Error('HTTP '+r.status); return r.text()});
}
async function fetchCsvAny(gid, timeoutEach=6000){
  const urls = csvUrls(gid);
  const attempts = urls.map(u => fetchWithTimeout(u, timeoutEach).then(txt=>{
    if(txt && !txt.trimStart().startsWith('<')) return txt;
    throw new Error('Respuesta inv√°lida');
  }));
  return new Promise((resolve, reject)=>{
    let rej=0, reason=null;
    attempts.forEach(p => p.then(resolve).catch(e=>{reason=e; if(++rej===attempts.length) reject(reason)}));
  });
}

/* Fetch por "sheet + range" (robusto, evita depender de gid para Configuracion) */
function rangeUrlsBySheet(sheetName, rangeA1){
  const ts = Date.now();
  const s = encodeURIComponent(sheetName);
  const r = encodeURIComponent(rangeA1);
  // gviz soporta sheet + range muy bien (ideal para celdas sueltas)
  return [
    `https://docs.google.com/spreadsheets/d/${KEY}/gviz/tq?tqx=out:csv&sheet=${s}&range=${r}&_=${ts}`,
    // fallback: a veces sheet+range funciona tambi√©n en export
    `https://docs.google.com/spreadsheets/d/${KEY}/export?format=csv&sheet=${s}&range=${r}&_=${ts}`
  ];
}
async function fetchCsvBySheetRange(sheetName, rangeA1, timeoutEach=5500){
  const urls = rangeUrlsBySheet(sheetName, rangeA1);
  const attempts = urls.map(u => fetchWithTimeout(u, timeoutEach).then(txt=>{
    if(txt && !txt.trimStart().startsWith('<')) return txt;
    throw new Error('Respuesta inv√°lida');
  }));
  return new Promise((resolve, reject)=>{
    let rej=0, reason=null;
    attempts.forEach(p => p.then(resolve).catch(e=>{reason=e; if(++rej===attempts.length) reject(reason)}));
  });
}

/* =========================
   Estado global liviano
   ========================= */
let ALL = {};             // { "0000": "libre"/"ocupado" }
let DAILY = [];           // hasta 240 render inmediato
let SEARCH_INPUT = null;
let GRID_TIMER = null;
let MAP_TIMER = null;
let MODAL_OPEN = false;
let DAY_MARK = null;

/* Carrito de compras */
let CART_ACTIVE = false;
let CART_ITEMS = [];

/* =========================
   Utils
   ========================= */
const pad4 = n => String(n).replace(/\D/g,'').slice(0,4).padStart(4,'0');
const todayKey = () => new Date().toISOString().slice(0,10);
function randInt(maxExclusive){
  if (crypto?.getRandomValues){ const b = new Uint32Array(1); crypto.getRandomValues(b); return b[0] % maxExclusive; }
  return Math.floor(Math.random()*maxExclusive);
}
function msg(text, error=false){
  const el = document.getElementById('message'); if(!el) return;
  el.textContent = text || ''; el.classList.toggle('error', !!error); el.style.display = 'block';
  clearTimeout(msg._t); msg._t = setTimeout(()=>{ el.style.display = 'none'; }, error ? 2000 : 1000);
}
function hideMsg(){ const el = document.getElementById('message'); if(!el) return; clearTimeout(msg._t); el.style.display='none'; }
function parseCSV(text){
  if (text.trimStart().startsWith('<')) return [];
  const rows=[]; let i=0,cur='',inQ=false; const push=()=>{ rows[rows.length-1].push(cur); cur='' };
  rows.push([]);
  while(i<text.length){
    const c=text[i];
    if(inQ){ if(c==='"'){ if(text[i+1]==='"'){cur+='"';i++} else inQ=false } else cur+=c; }
    else{ if(c==='"'){ inQ=true } else if(c===','){ push() } else if(c==='\n'){ push(); rows.push([]) } else if(c!=='\r'){ cur+=c } }
    i++;
  }
  push(); return rows.filter(r => r.some(x=>String(x).trim()!=='')); 
}
function makeBaseMap(){ const map={}; for(let i=0;i<10000;i++){ map[String(i).padStart(4,'0')]='ocupado' } return map }
function normStatusAB(s){ const t=String(s??'').trim().toLowerCase(); return t==='libre' ? 'libre' : 'ocupado' }
function extractColombiaDigits(raw){
  const chunks=(String(raw||'').match(/\d+/g)||[]); let d=chunks.join(''); d=d.replace(/^00/,'');
  const m=d.match(/57(3\d{9})/); if(m) return '57'+m[1];
  const m2=d.match(/(?:^|[^0-9])(3\d{9})(?:[^0-9]|$)/); if(m2) return '57'+m2[1];
  const m3=d.match(/0(3\d{9})/); if(m3) return '57'+m3[1];
  if(d.startsWith('57') && d.length>=12) return d.slice(0,12);
  return null;
}

/* =========================================================
   ‚úÖ WHATSAPP √öNICO (Config. interna: Configuracion!L2)
   - Elimina por completo cualquier n√∫mero por defecto.
   - La app NO inicia si no logra leer/validar este n√∫mero.
   ========================================================= */
function parseSingleCellFromCsv(text){
  const rows = parseCSV(text);
  return rows?.[1]?.[0] ?? rows?.[0]?.[0] ?? '';
}
function normalizeWhatsAppDigitsStrict(raw){
  const digits = extractColombiaDigits(raw);
  // En Colombia: '57' + 10 d√≠gitos (celular 3xxxxxxxxx) => total 12
  if(!digits || !/^57\d{10}$/.test(digits)) return null;
  return digits;
}
async function loadWhatsAppDigitsStrict(){
  // ‚ö†Ô∏è Importante: NO usar cach√© como "seguridad". Se exige lectura real al abrir.
  const txt = await fetchCsvBySheetRange(WA_SHEET_NAME, WA_CELL_RANGE, 5500);
  const cell = parseSingleCellFromCsv(txt);
  const digits = normalizeWhatsAppDigitsStrict(cell);
  if(!digits){
    throw new Error('WhatsApp inv√°lido en Configuracion!L2: ' + String(cell||'').trim());
  }
  // √önico origen v√°lido para WhatsApp en toda la p√°gina
  window.__WHATSAPP_DIGITS = digits;
  // Mantener compatibilidad con variables existentes en el c√≥digo
  window.__CONFIG_PHONE_DIGITS = digits;
  return digits;
}


/* Recalcular altura del header cuando aparece/desaparece el carrito */
function recalcHeaderHeightDynamic(){
  // requestAnimationFrame asegura que el navegador ya dibuj√≥ el carrito 
  // y el bot√≥n "Finalizar" antes de medir la altura real.
  requestAnimationFrame(() => {
    const hEl = document.querySelector('header');
    if(!hEl) return;
    const h = Math.max(70, Math.round(hEl.getBoundingClientRect().height));
    document.documentElement.style.setProperty('--header-h', h + 'px');
  });
}

/* =========================================================
   ‚úÖ 1) CHEQUEO DE BLOQUEO (Configuracion!X2)
   ========================================================= */
function normalizeBoolCell(v){
  const t = String(v ?? '').trim().toUpperCase();
  if(t === 'TRUE') return true;
  if(t === 'FALSE') return false;
  // tolerancia por si llegan "Si/No" o "1/0"
  if(t === 'SI' || t === 'YES' || t === '1') return true;
  if(t === 'NO' || t === '0') return false;
  return null; // desconocido
}
async function getBlockedFlagFast(){
  // cache r√°pido (pero corto)
  const bc = loadBlockCache();
  if(bc && !bc.stale) return bc.isBlocked;

  try{
    const txt = await fetchCsvBySheetRange(BLOCK_SHEET_NAME, BLOCK_CELL_RANGE, 4500);
    const rows = parseCSV(txt);
    const cell = rows?.[1]?.[0] ?? rows?.[0]?.[0] ?? '';
    const val = normalizeBoolCell(cell);
    if(val === null) throw new Error('Valor bloqueo inv√°lido: ' + cell);
    saveBlockCache(val);
    return val;
  }catch(_){
    // Si falla, usa cache viejo si hay; si no, asume NO bloqueado para no dejarte tirado
    if(bc) return bc.isBlocked;
    return false;
  }
}

/* =========================================================
   ‚úÖ 2) LOGO DESDE Notificaciones!D2 (gid=1029797655)
   ========================================================= */
function applyLogoUrl(url){
  const u = String(url||'').trim();
  if(!u) return;
  const img = document.getElementById('logoImg');
  const bimg = document.getElementById('bootLogoImg');
  if(img) img.src = u;
  if(bimg) bimg.src = u;
}
async function loadLogoFast(){
  const cached = loadLogoCache();
  if(cached?.logo) applyLogoUrl(cached.logo);

  // Intento 1: leer celda suelta (sheet+range) por nombre (m√°s portable)
  try{
    const txt = await fetchCsvBySheetRange('Notificaciones', LOGO_CELL_RANGE, 5000);
    const rows = parseCSV(txt);
    const cell = rows?.[1]?.[0] ?? rows?.[0]?.[0] ?? '';
    const u = String(cell||'').trim();
    if(u){
      applyLogoUrl(u);
      saveLogoCache(u);
      return;
    }
  }catch(_){}

  // Intento 2: fallback por gid completo y tomar D2 (por si "sheet" no est√° publicado)
  try{
    const txt = await fetchCsvAny(GID_NOTIFICATIONS, 5500);
    const rows = parseCSV(txt);
    // D2 = fila index 1, col index 3
    const cell = rows?.[1]?.[3] ?? '';
    const u = String(cell||'').trim();
    if(u){
      applyLogoUrl(u);
      saveLogoCache(u);
      return;
    }
  }catch(_){}
}

/* =========================
   UI helpers
   ========================= */
function closeBox(withScale){
  const ov=document.getElementById('ov'), box=document.getElementById('box');
  if(!ov||!box) return;
  const a1 = box.animate(withScale?[{transform:'scale(1)',opacity:1},{transform:'scale(.94)',opacity:0}]:[{opacity:1},{opacity:0}],{duration:180,easing:'ease-in',fill:'forwards'});
  const a2 = ov.animate([{backgroundColor:'rgba(0,0,0,0.35)'},{backgroundColor:'rgba(0,0,0,0)'}],{duration:180,fill:'forwards'});
  Promise.all([a1.finished,a2.finished]).catch(()=>{}).finally(()=>{
    MODAL_OPEN=false; ov.classList.remove('show'); ov.setAttribute('aria-hidden','true');
    box.style.opacity='1'; box.style.transform='none'; ov.style.backgroundColor='rgba(0,0,0,0.35)';
  });
}

/* Abrir WhatsApp */
function openWA(payload){
  const tel = window.__WHATSAPP_DIGITS || window.__CONFIG_PHONE_DIGITS || '';
  let message = '';

  if (Array.isArray(payload)) {
    const unique = Array.from(new Set(payload.map(pad4)));
    if (!unique.length) return;
    const listado = unique.map((n,idx)=> `${idx+1}. ${n}`).join('\n');
    message =
      `Hola, estoy interesado en separar los siguientes n√∫meros:\n\n` +
      `${listado}\n\n` +
      `Total: ${unique.length} n√∫mero${unique.length>1?'s':''}.\n\n` +
      `Quedo atento(a) a la confirmaci√≥n de disponibilidad.`;
  } else {
    const number = pad4(payload);
    message = "Hola, estoy interesado en separar este n√∫mero: " + number;
  }

  const url = "https://wa.me/" + tel + "?text=" + encodeURIComponent(message);
  const w = window.open(url, '_blank');
  if (!w){ location.href = url; }
}

/* Carrito */
function updateTopFinishVisibility(){
  const btn = document.getElementById('finishTop');
  if(!btn) return;
  if (CART_ACTIVE && CART_ITEMS.length){
    btn.style.display = 'inline-flex';
  } else {
    btn.style.display = 'none';
  }
}
function renderCart(){
  const panel = document.getElementById('cartPanel');
  if(!panel) return;
  panel.innerHTML = '';

  if(!CART_ITEMS.length){
    panel.style.display = 'none';
    recalcHeaderHeightDynamic();
    return;
  }

  panel.style.display = 'flex';

  const label = document.createElement('div');
  label.className = 'cart-label';
  label.textContent = 'Carrito (' + CART_ITEMS.length + ')';
  panel.appendChild(label);

  const strip = document.createElement('div');
  strip.className = 'cart-strip';
  panel.appendChild(strip);

  CART_ITEMS.slice().reverse().forEach(num=>{
  const item = document.createElement('div');
  item.className = 'cart-item';
  item.dataset.num = num;
  item.innerHTML =
    `<span class="cart-item-num">${num}</span>`+
    `<button type="button" class="cart-item-remove" aria-label="Quitar ${num}">&times;</button>`;
  strip.appendChild(item);
   });

  strip.addEventListener('click', (ev)=>{
    const btn = ev.target.closest('.cart-item-remove');
    if(!btn) return;
    const parent = btn.closest('.cart-item');
    const num = parent?.dataset.num;
    if(!num) return;
    removeFromCart(num);
  });

  recalcHeaderHeightDynamic();
}
function setTileSelected(num, selected){
  const p = pad4(num);
  // N√∫meros son 4 d√≠gitos, as√≠ que el selector es seguro y ultra r√°pido
  document.querySelectorAll(`.raffle[data-num="${p}"]`).forEach(el=>{
    el.classList.toggle('selected', !!selected);
  });
}

function addToCart(n){
  const num = pad4(n);

  if (!CART_ITEMS.includes(num)){
    CART_ITEMS.push(num);
  }

  // ‚úÖ Marcar visualmente en la grilla + en la b√∫squeda
  setTileSelected(num, true);

  if(!CART_ACTIVE){
    CART_ACTIVE = true;
    document.body.classList.add('cart-active');
  }
  renderCart();
  updateTopFinishVisibility();
}
function removeFromCart(num){
  const n = pad4(num);
  const idx = CART_ITEMS.indexOf(n);
  if(idx>-1){
    CART_ITEMS.splice(idx,1);
  }

  // ‚úÖ Desmarcar visualmente
  setTileSelected(n, false);

  if(!CART_ITEMS.length){
    CART_ACTIVE = false;
    document.body.classList.remove('cart-active');
  }
  renderCart();
  updateTopFinishVisibility();
}

function finalizeCart(){
  if(!CART_ITEMS.length){
    msg('No hay n√∫meros en el carrito', true);
    return;
  }
  const unique = Array.from(new Set(CART_ITEMS.map(pad4)));
  // Limpia selecci√≥n visual (por si vuelves a la p√°gina)
  unique.forEach(n => setTileSelected(n, false));
  openCheckoutModal(unique);
}
let CHECKOUT_NUMBERS = [];

function openCheckoutModal(numbers){
  CHECKOUT_NUMBERS = numbers.slice();
  const bd = document.getElementById('checkoutBackdrop');
  const sum = document.getElementById('checkoutSummary');
  const name = document.getElementById('checkoutName');
  const phone = document.getElementById('checkoutPhone');

  if(sum) sum.textContent = `Boletas seleccionadas: ${numbers.join(', ')}`;
  if(name) name.value = '';
  if(phone) phone.value = '';
  if(bd){ bd.style.display='flex'; }
  setTimeout(()=>{ if(name) name.focus(); }, 50);
}

function closeCheckoutModal(){
  const bd = document.getElementById('checkoutBackdrop');
  if(bd) bd.style.display='none';
}

function showLoading(title, text){
  const scr = document.getElementById('loadingScreen');
  const t = document.getElementById('loadingTitle');
  const p = document.getElementById('loadingText');
  const btn = document.getElementById('loadingContinue');
  if(t) t.textContent = title || 'Procesando‚Ä¶';
  if(p) p.textContent = text || '';
  if(btn) btn.style.display='none';
  if(scr) scr.style.display='flex';
}

function showResult(ok, message){
  const scr = document.getElementById('loadingScreen');
  const t = document.getElementById('loadingTitle');
  const p = document.getElementById('loadingText');
  const btn = document.getElementById('loadingContinue');
  if(t) t.textContent = ok ? 'Registro exitoso' : 'No se pudo registrar';
  if(p) p.textContent = message || (ok ? 'Compra registrada correctamente.' : 'Ocurri√≥ un error.');
  if(btn) btn.style.display='block';
  if(scr) scr.style.display='flex';
}

function hideLoading(){
  const scr = document.getElementById('loadingScreen');
  if(scr) scr.style.display='none';
}

function normalizePhoneLocal_(raw){
  let s = String(raw||'').trim();
  s = s.replace(/[^\d]/g,'');
  if(s.length===10) return '57'+s;
  if(s.length===12 && s.startsWith('57')) return s;
  return null;
}

async function submitCheckout(){
  const nameEl = document.getElementById('checkoutName');
  const phoneEl = document.getElementById('checkoutPhone');
  const name = (nameEl ? nameEl.value : '').trim();
  const phoneNorm = normalizePhoneLocal_(phoneEl ? phoneEl.value : '');

  if(name.length < 2){ msg('Escribe un nombre v√°lido', true); if(nameEl) nameEl.focus(); return; }
  if(!phoneNorm){ msg('Tel√©fono inv√°lido. Usa 10 d√≠gitos (Ej: 3001234567)', true); if(phoneEl) phoneEl.focus(); return; }
  if(!CHECKOUT_NUMBERS.length){ msg('No hay boletas seleccionadas', true); return; }

  closeCheckoutModal();
  showLoading('Registrando compra‚Ä¶', 'Guardando datos en el sistema.');

  try{
    const payload = {
      action: 'reserve',
      sheet: 'Numero_De_Rifas',
      numbers: CHECKOUT_NUMBERS,
      name,
      phone: phoneNorm
    };

    const resp = await fetch(APPS_SCRIPT_WEBAPP_URL, {
      method: 'POST',
      mode: 'cors',
      // IMPORTANT: text/plain evita preflight OPTIONS
      headers: {'Content-Type': 'text/plain;charset=utf-8'},
      body: JSON.stringify(payload)
    });

    const data = await resp.json().catch(()=>null);

    if(!resp.ok){
      showResult(false, `HTTP ${resp.status}. ${data && data.message ? data.message : 'Error al guardar.'}`);
      return;
    }

    if(!data || data.ok !== true){
      const msgErr = (data && data.message) ? data.message : 'No se pudo registrar.';
      showResult(false, msgErr);
      return;
    }

    // Limpia carrito y refresca disponibilidad
    CART_ITEMS = [];
    CART_ACTIVE = false;
    document.body.classList.remove('cart-active');
    renderCart();
    updateTopFinishVisibility();

    // Refresca mapa y grid
    await syncMapFast();
    renderGrid();

    showResult(true, 'Compra registrada correctamente.');
  }catch(err){
    showResult(false, String(err && err.message ? err.message : err));
  }
}


function makeTile(num, large){
  const el = document.createElement('div');
  const p = pad4(num);
  el.className = 'raffle' + (large ? ' large-raffle' : '');
  el.dataset.num = p;
  el.innerHTML = `<span class="num">${p}</span><span class="tick" aria-hidden="true">‚úì</span>`;
  if (CART_ITEMS.includes(p)) el.classList.add('selected');

  el.addEventListener('pointerdown', (ev)=>{ el._lastPt = {x:ev.clientX, y:ev.clientY}; }, {passive:true});
  el.addEventListener('touchstart', (ev)=>{ const t=ev.touches&&ev.touches[0]; if(t) el._lastPt={x:t.clientX,y:t.clientY}; }, {passive:true});
  el.addEventListener('click', (ev)=> onTileTap(el, p, el._lastPt || {x:ev.clientX, y:ev.clientY}), {passive:true});
  return el;
}
function renderGrid(){
  const wrap=document.getElementById('raffles'); if(!wrap) return;
  if(document.body.classList.contains('search-has-text') || MODAL_OPEN) return;
  wrap.innerHTML='';
  const frag = document.createDocumentFragment();
  for(const n of DAILY){ frag.appendChild(makeTile(n,false)); }
  wrap.appendChild(frag);
}
function renderSearchOne(num){
  const layer=document.getElementById('searchResult');
  layer.style.display='none'; layer.innerHTML=''; if(!num) return;
  const t=makeTile(num,true); layer.appendChild(t); layer.style.display='flex';
  requestAnimationFrame(()=> t.classList.add('revealed'));
}
function clearSearchLayer(){ const layer=document.getElementById('searchResult'); layer.style.display='none'; layer.innerHTML='' }

/* =========================
   Config p√∫blica (r√°pida con cach√©)
   ========================= */
async function loadConfigFast(){
  const cached = loadConfCache();
  if (cached?.conf){ applyConfig(cached.conf); }
  try{
    const txt = await fetchCsvAny(GID_CONFIG, 5000);
    const rows = parseCSV(txt);
    if(rows.length>=2){
      const conf = readConf(rows);
      applyConfig(conf);
      saveConfCache(conf);
    }
  }catch(_){ /* usar cach√© si existe */ }
}
function readConf(rows){
  const head=rows[0], data=rows[1];
  const hIdx=(name)=> head.findIndex(h => String(h).trim().toLowerCase()===name.toLowerCase());
  return {
    name: data[hIdx('Nombre_APP')] || data[hIdx('Nombre_De_La_Rifa')] || 'Rifas',
    phoneRaw: data[hIdx('Telefonos')] || '',
    address: data[hIdx('Direccion')] || '',
    logo: data[hIdx('Logo')] || ''
  };
}
function applyConfig({name,phoneRaw,address,logo}){
  document.getElementById('houseName').textContent = String(name||'').trim();
  document.getElementById('phone').textContent = phoneRaw ? ('Tel: ' + phoneRaw) : '';
  document.getElementById('address').textContent = address ? ('Dir: ' + address) : '';

  // guardamos para pantalla bloqueada
  window.__CONFIG_NAME = String(name||'').trim();
  window.__CONFIG_PHONE = String(phoneRaw||'').trim();
  window.__CONFIG_ADDR = String(address||'').trim();

  // logo base (solo fallback)
  const baseLogo = String(logo||'').trim();
  if(baseLogo){
    document.getElementById('logoImg').src = baseLogo;
    const b = document.getElementById('bootLogoImg'); if(b && !b.src) b.src = baseLogo;
  }

  /* WhatsApp se toma √öNICAMENTE de Configuracion!L2 (ver loadWhatsAppDigitsStrict) */
  // window.__CONFIG_PHONE_DIGITS se define al validar Configuracion!L2

}

/* =========================
   Mapa r√°pido (cach√© primero)
   ========================= */
function setAllFromFreeList(freeList){
  const map = makeBaseMap();
  for(const n of freeList){ map[n] = 'libre'; }
  ALL = map;
}
function sampleDailyFromFreeList(freeList, target=240){
  const L = freeList.length;
  if(L<=target) return [...freeList];
  const out = freeList.slice(0, target);
  for(let i=target;i<L;i++){
    const j = randInt(i+1);
    if(j<target) out[j] = freeList[i];
  }
  return out;
}
function persistDaily(){
  const key = dailyKey();
  try{ localStorage.setItem(key, JSON.stringify(DAILY||[])) }catch(_){}
}
function loadDailyFromCache(){
  const key = dailyKey();
  try{
    const cached = JSON.parse(localStorage.getItem(key) || '[]');
    if(Array.isArray(cached) && cached.length){
      DAILY = cached.filter(n => ALL[n] === 'libre');
      persistDaily();
      return DAILY.length > 0;
    }
  }catch(_){}
  return false;
}
function pickDaily(force=false){
  if(!force && loadDailyFromCache()) return;
  const libres = Object.keys(ALL||{}).filter(k=>ALL[k]==='libre');
  DAILY = sampleDailyFromFreeList(libres, 240);
  persistDaily();
}

/* =========================
   Sincronizaci√≥n remota
   ========================= */
async function syncMapFast(){
  try{
    const txt = await fetchCsvAny(GID_RAFFLES, 6000);
    const rows = parseCSV(txt);
    if(rows.length < 2) return;
    const freeList=[];
    for(let i=1;i<rows.length;i++){
      const r=rows[i]||[]; const a=(r[0]??'').toString().trim(); const b=(r[1]??'').toString().trim();
      if(!a) continue; let digits=a.replace(/\D/g,''); if(!digits) continue;
      if(digits.length>4) digits=digits.slice(0,4);
      const num=digits.padStart(4,'0');
      if (normStatusAB(b)==='libre') freeList.push(num);
    }
    saveMapCache(freeList);
    setAllFromFreeList(freeList);
    const before=DAILY.length;
    DAILY = DAILY.filter(n=>ALL[n]==='libre');
    if(DAILY.length===0){ pickDaily(true); }
    if(DAILY.length!==before){ renderGrid(); }
  }catch(_){ }
}

/* =========================
   B√∫squeda
   ========================= */
async function rerenderSearch(){
  const layer=document.getElementById('searchResult'); hideMsg();
  const raw=(SEARCH_INPUT.value||'').replace(/\D/g,'').slice(0,4);
  if(SEARCH_INPUT.value!==raw) SEARCH_INPUT.value=raw;
  layer.style.display='none'; layer.innerHTML='';
  if(raw.length===0){ document.body.classList.remove('search-has-text'); return; }
  document.body.classList.add('search-has-text');
  const padded=pad4(raw); const st=ALL[padded]||'ocupado';
  if(st==='libre'){ hideMsg(); renderSearchOne(padded); } else { clearSearchLayer(); msg('Boleta ocupada', true); }
}

/* =========================
   EFECTOS (on-demand)
   ========================= */
function overlayCanvas(container){
  if(!container) return null;
  const cs=getComputedStyle(container);
  if(cs.position==='static') container.style.position='relative';
  const rect=container.getBoundingClientRect();
  const dpr=Math.min(window.devicePixelRatio||1,2);
  const c=document.createElement('canvas'); const w=Math.max(1,Math.floor(rect.width*dpr)); const h=Math.max(1,Math.floor(rect.height*dpr));
  c.width=w; c.height=h; c.style.width=rect.width+'px'; c.style.height=rect.height+'px';
  c.style.position='absolute'; c.style.inset='0'; c.style.pointerEvents='none'; c.style.zIndex='5';
  container.appendChild(c); const ctx=c.getContext('2d');
  return {c,ctx,dpr,w,h,cleanup:()=>c.remove()};
}
function fullscreenCanvas(parent){
  const dpr=Math.min(window.devicePixelRatio||1,2);
  const c=document.createElement('canvas'); const w=Math.max(1,Math.floor(window.innerWidth*dpr)); const h=Math.max(1,Math.floor(window.innerHeight*dpr));
  c.width=w; c.height=h; c.style.width='100%'; c.style.height='100%';
  c.style.position='absolute'; c.style.inset='0'; c.style.pointerEvents='none'; c.style.zIndex='1';
  parent.appendChild(c); const ctx=c.getContext('2d');
  return {c,ctx,dpr,w,h,cleanup:()=>c.remove()};
}
function animateMs(duration, draw){
  return new Promise(res=>{
    const s=performance.now(); let last=s, id=0;
    function loop(t){ const e=t-s; const dt=Math.min(64,t-last)/1000; last=t; const p=Math.min(1,e/duration); draw(p,dt,e); if(e<duration){ id=requestAnimationFrame(loop) } else { cancelAnimationFrame(id); res(); } }
    id=requestAnimationFrame(loop);
  });
}
const easeOutCubic=x=>1-Math.pow(1-x,3);
const rgba=(r,g,b,a)=>`rgba(${r},${g},${b},${a})`;

function playWaterRipple(container, duration=1200, center){
  if(!container) return Promise.resolve();
  if(matchMedia('(prefers-reduced-motion: reduce)').matches) return Promise.resolve();
  const oc=overlayCanvas(container); if(!oc) return Promise.resolve();
  const {ctx,w,h,dpr,cleanup}=oc;
  const cx=center?.x ?? (w/2), cy=center?.y ?? (h/2);
  const sparkCols=[[255,212,77],[0,255,169]];
  const SPN=Math.floor(14*Math.min(1.5,(w*h)/60000));
  const sparks=[];
  for(let i=0;i<SPN;i++){
    const ang=Math.random()*Math.PI*2, sp=(120+Math.random()*160)*dpr;
    sparks.push({x:cx,y:cy,vx:Math.cos(ang)*sp,vy:Math.sin(ang)*sp-70*dpr,r:(1+Math.random()*1.8)*dpr,life:0,max:0.5+Math.random()*0.45,col:sparkCols[(Math.random()*sparkCols.length)|0]});
  }
  const maxR=Math.hypot(w,h)*0.55; const rings=[{d:0},{d:110},{d:220}];
  function ring(R,th,a){
    if(R<=0||th<=0||a<=0)return;
    const inner=Math.max(0.0001,R-th), outer=R+th;
    const g=ctx.createRadialGradient(cx,cy,inner,cx,cy,outer);
    g.addColorStop(0.0,'rgba(0,0,0,0)');
    g.addColorStop(0.18,rgba(0,0,0,0.22*a));
    g.addColorStop(0.45,rgba(255,255,255,0.50*a));
    g.addColorStop(0.62,rgba(0,255,169,0.58*a));
    g.addColorStop(0.84,rgba(61,183,255,0.30*a));
    g.addColorStop(1.0,'rgba(0,0,0,0)');
    ctx.fillStyle=g; ctx.fillRect(0,0,w,h);
    ctx.save(); ctx.lineWidth=Math.max(0.8,2.5*dpr*(1-R/maxR)); ctx.strokeStyle=rgba(255,255,255,0.3*a);
    const arcLen=Math.PI*0.5, rot=-Math.PI/6; ctx.beginPath(); ctx.arc(cx,cy,R,rot,rot+arcLen); ctx.stroke(); ctx.restore();
  }
  return animateMs(duration,(p,dt,ms)=>{
    ctx.clearRect(0,0,w,h);
    const dimA=0.22*easeOutCubic(Math.min(1,ms/180)); ctx.fillStyle=rgba(0,0,0,dimA); ctx.fillRect(0,0,w,h);
    for(const r of rings){
      const t=ms-r.d; if(t<0) continue;
      const pr=Math.min(1,t/(duration-r.d+1)); const amp=(1-pr)*0.95; const R=pr*maxR; const th=Math.max(1.2*dpr, 9*dpr*(1-pr));
      ring(R,th,amp);
    }
    ctx.globalCompositeOperation='lighter';
    for(const s of sparks){
      s.life+=dt; s.vx*=(1-0.55*dt); s.vy*=(1-0.55*dt); s.vy+=200*dt*dpr*0.25; s.x+=s.vx*dt; s.y+=s.vy*dt;
      const a=Math.max(0,1-(s.life/s.max)); if(a<=0) continue;
      ctx.beginPath(); ctx.fillStyle=rgba(s.col[0],s.col[1],s.col[2],0.9*a); ctx.arc(s.x,s.y,s.r,0,Math.PI*2); ctx.fill();
      if(Math.random()<0.08){ ctx.beginPath(); ctx.fillStyle=rgba(255,255,255,0.55*a); ctx.arc(s.x,s.y,s.r*0.5,0,Math.PI*2); ctx.fill(); }
    }
    ctx.globalCompositeOperation='source-over';
  }).then(cleanup);
}
async function drawTrailFromTileToBox(tile, box, ov, duration=480){
  if(matchMedia('(prefers-reduced-motion: reduce)').matches) return;
  const fs=fullscreenCanvas(ov); if(!fs) return;
  const {ctx,dpr,cleanup}=fs;
  const tr=tile.getBoundingClientRect(), br=box.getBoundingClientRect();
  const sx=(tr.left+tr.width/2)*dpr, sy=(tr.top+tr.height/2)*dpr;
  const ex=(br.left+br.width/2)*dpr, ey=(br.top+br.height/2)*dpr;
  const ctrl={x:(sx+ex)/2, y:Math.min(sy,ey)-100*dpr};
  const sparks=[];
  function addSpark(px,py){ sparks.push({x:px,y:py,vx:(Math.random()-0.5)*100*dpr,vy:(Math.random()-0.8)*140*dpr,life:0,max:0.22+Math.random()*0.18,r:(0.7+Math.random()*1.4)*dpr,col: (Math.random()<0.5 ? [255,212,77] : [0,255,169])}); }
  await animateMs(duration,(p,dt)=>{
    const w=window.innerWidth*dpr, h=window.innerHeight*dpr;
    ctx.clearRect(0,0,w,h);
    const t=p;
    const x=(1-t)*(1-t)*sx + 2*(1-t)*t*ctrl.x + t*t*ex;
    const y=(1-t)*(1-t)*sy + 2*(1-t)*t*ctrl.y + t*t*ey;
    const base=Math.max(1.5*dpr, 8*dpr*(1-p));
    const grd=ctx.createLinearGradient(x,y,sx,sy);
    grd.addColorStop(0,'rgba(255,255,255,0.85)');
    grd.addColorStop(0.25,'rgba(255,212,77,0.7)');
    grd.addColorStop(1,'rgba(0,255,169,0.0)');
    ctx.save(); ctx.lineCap='round'; ctx.lineJoin='round'; ctx.shadowBlur=16*dpr; ctx.shadowColor='rgba(255,212,77,0.5)';
    ctx.strokeStyle=grd; ctx.lineWidth=base; ctx.beginPath(); ctx.moveTo(sx,sy); ctx.quadraticCurveTo(ctrl.x,ctrl.y,x,y); ctx.stroke();
    ctx.shadowBlur=22*dpr; ctx.fillStyle='rgba(255,255,255,0.9)'; ctx.beginPath(); ctx.arc(x,y,base*0.36,0,Math.PI*2); ctx.fill();
    ctx.shadowColor='rgba(0,255,169,0.5)'; ctx.strokeStyle='rgba(0,255,169,0.4)'; ctx.lineWidth=base*0.5;
    ctx.beginPath(); ctx.moveTo(sx,sy); ctx.quadraticCurveTo(ctrl.x,ctrl.y,x,y); ctx.stroke(); ctx.restore();
    addSpark(x,y);
    ctx.globalCompositeOperation='lighter';
    for(let i=sparks.length-1;i>=0;i--){
      const s=sparks[i]; s.life+=dt; s.vx*=(1-0.5*dt); s.vy+=180*dt*dpr*0.3; s.x+=s.vx*dt; s.y+=s.vy*dt;
      const a=Math.max(0,1-s.life/s.max); if(a<=0){sparks.splice(i,1); continue;}
      ctx.beginPath(); ctx.fillStyle=rgba(s.col[0],s.col[1],s.col[2],0.9*a); ctx.arc(s.x,s.y,s.r,0,Math.PI*2); ctx.fill();
    }
    ctx.globalCompositeOperation='source-over';
  });
  cleanup();
}
function showChoiceFromTile(tile, n){
  const ov=document.getElementById('ov'), box=document.getElementById('box');
  const yes=document.getElementById('yes'), no=document.getElementById('no'), q=document.getElementById('q');
  const keep=document.getElementById('keep');
  if(!ov||!box||!yes||!no||!q||!keep) return;

  MODAL_OPEN=true;

  if(!CART_ACTIVE){
    q.textContent = "¬øQuieres separar este n√∫mero? " + n;
    yes.style.display = 'inline-block';
    no.style.display = 'inline-block';
    keep.style.display = 'inline-block';
    yes.textContent = 'S√≠';
    no.textContent = 'No';
    keep.textContent = 'Seguir separando';
  }else{
    q.textContent = "Has seleccionado el n√∫mero " + n;
    keep.style.display = 'inline-block';
    yes.style.display = 'inline-block';
    no.style.display = 'none';
    keep.textContent = 'Seguir separando';
    yes.textContent = 'Finalizar';
  }

  ov.classList.add('show'); ov.setAttribute('aria-hidden','false');
  box.style.opacity='0'; box.style.transform='translate(0,0) scale(1)'; box.style.willChange='transform,opacity';

  requestAnimationFrame(async ()=>{
    const tr=tile.getBoundingClientRect(), br=box.getBoundingClientRect();
    const tx=tr.left+tr.width/2, ty=tr.top+tr.height/2, bx=br.left+br.width/2, by=br.top+br.height/2;
    const dx=tx-bx, dy=ty-by;
    drawTrailFromTileToBox(tile,box,ov,480).catch(()=>{});
    ov.animate([{backgroundColor:'rgba(0,0,0,0)'},{backgroundColor:'rgba(0,0,0,0.35)'}],{duration:220,easing:'ease-out',fill:'forwards'});
    const kf=[{transform:`translate(${dx}px,${dy}px) scale(0.26)`,opacity:0},
              {transform:`translate(${dx*0.10}px,${dy*0.10}px) scale(1.06)`,opacity:1,offset:0.66},
              {transform:'translate(0,0) scale(1)',opacity:1}];
    const a=box.animate(kf,{duration:520,easing:'cubic-bezier(.2,1,.2,1)',fill:'forwards'});
    a.onfinish=()=>{box.style.opacity='1'; box.style.transform='none'; box.style.willChange='auto';};
  });

  yes.onclick = (e)=>{
    e.preventDefault(); e.stopPropagation();
    if(CART_ACTIVE){
      addToCart(n);
      closeBox(true);
      finalizeCart();
    }else{
      closeBox(true);
      openWA(n);
    }
  };
  no.onclick = (e)=>{ e.preventDefault(); e.stopPropagation(); closeBox(false); };
  keep.onclick = (e)=>{ e.preventDefault(); e.stopPropagation(); addToCart(n); closeBox(true); };
  ov.onclick = ()=> closeBox(false);
  box.onclick=(e)=> e.stopPropagation();
}
function onTileTap(el, num, pt){
  if(!el || el.dataset.busy==='1') return;

  const n = pad4(num);

  // Si el mapa dice que est√° ocupada, no permitimos agregar
  const st = ALL?.[n];
  if(st && st !== 'libre'){
    msg('Boleta ocupada', true);
    return;
  }

  // üî• NUEVA L√ìGICA UX: Si ya estaba seleccionada, la retiramos con un solo toque
  if(CART_ITEMS.includes(n)){
    removeFromCart(n);
    msg('Boleta retirada: ' + n, false);
    
    // Micro-interacci√≥n: Peque√±o efecto de "hundimiento" al desmarcar
    el.style.transform = 'scale(0.95)';
    setTimeout(() => { el.style.transform = ''; }, 150);
    return;
  }

  el.dataset.busy='1';
  hideMsg();

  const rect=el.getBoundingClientRect();
  const dpr=Math.min(window.devicePixelRatio||1,2);
  const cx=((pt?.x ?? (rect.left+rect.width/2)) - rect.left)*dpr;
  const cy=((pt?.y ?? (rect.top+rect.height/2))  - rect.top )*dpr;

  // Efecto visual premium (Onda de luz)
  playWaterRipple(el, 900, {x:cx,y:cy})
    .finally(()=>{ el.dataset.busy=''; });

  // ‚úÖ Directo al carrito
  addToCart(n);
  msg('Agregada al carrito: ' + n, false);
}

/* =========================
   INIT ultrarr√°pido + BLOQUEO
   ========================= */
document.addEventListener('DOMContentLoaded', async ()=>{
  bootShow();
  bootSet(10, 'Iniciando‚Ä¶', 'Verificando estado y preparando interfaz');

  function updateHeaderPadding(){ recalcHeaderHeightDynamic(); }
  function applyViewportOffset(){
    let top = 0;

    if (window.visualViewport){
      const vv = window.visualViewport;

      // ‚úÖ Solo aplicar offset cuando realmente parece teclado abierto.
      // En iOS Safari, offsetTop cambia durante el scroll normal por la barra del navegador.
      const keyboardLikely = (window.innerHeight - vv.height) > 120;

      if (keyboardLikely){
        top = Math.max(0, Math.round(vv.offsetTop || 0));
        // ‚úÖ Clamp defensivo para evitar valores locos que crean ‚Äúvelos‚Äù gigantes/parpadeos
        top = Math.min(top, 180);
      } else {
        top = 0;
      }
    }

    document.documentElement.style.setProperty('--vv-top', top + 'px');
    updateHeaderPadding();
  }
  updateHeaderPadding(); applyViewportOffset();

  if (window.visualViewport){
    visualViewport.addEventListener('resize', ()=>requestAnimationFrame(applyViewportOffset));
    // ‚ùå NO escuchar visualViewport.scroll (glitch iOS)
  }
  window.addEventListener('resize', ()=>requestAnimationFrame(applyViewportOffset), { passive:true });

  // Carga base (config + logo) en paralelo para que boot se vea pro y r√°pido
  bootSet(18, 'Cargando configuraci√≥n‚Ä¶', 'Aplicando nombre, tel√©fono, direcci√≥n y logo');
  await Promise.allSettled([
    loadConfigFast(),
    loadLogoFast()
  ]);

  // T√≠tulo boot con el nombre (si ya est√° disponible)
  const bt = document.getElementById('bootTitle');
  if(bt) bt.textContent = (window.__CONFIG_NAME ? window.__CONFIG_NAME : 'Rifas');

  // ‚úÖ Chequeo bloqueo lo primero (ya con datos b√°sicos)
  bootSet(28, 'Verificando habilitaci√≥n‚Ä¶', 'Leyendo Configuracion!X2');
  const isBlocked = await getBlockedFlagFast();
  if(isBlocked === true){
    showBlockedScreen('Acceso restringido por configuraci√≥n (Configuracion!X2 = TRUE).');
    return; // ‚õî no contin√∫a la app
  }

  // ‚úÖ WHATSAPP √öNICO (Config. interna)
  bootSet(34, 'Verificando WhatsApp‚Ä¶', 'Leyendo Configuracion!L2');
  try{
    await loadWhatsAppDigitsStrict();
  }catch(err){
    // No iniciar si no hay validaci√≥n real del WhatsApp
    showBlockedScreen('No se pudo validar el n√∫mero de WhatsApp (Configuracion!L2).\n\nRevisa que L2 tenga un celular v√°lido (ej: 3XXXXXXXXX) y que la hoja sea accesible para lectura.');
    return;
  }

  // Inputs
  bootSet(40, 'Activando b√∫squeda‚Ä¶', 'Optimizando para celular');
  const SEARCH_INPUT_EL=document.getElementById('search'); SEARCH_INPUT=SEARCH_INPUT_EL;

  function instantFocus(e){
    if(document.activeElement!==SEARCH_INPUT){
      e.preventDefault(); SEARCH_INPUT.focus({preventScroll:true});
      setTimeout(()=>{ try{ const len=SEARCH_INPUT.value.length; SEARCH_INPUT.setSelectionRange(len,len);}catch(_){ }},0);
    }
  }
  SEARCH_INPUT.addEventListener('pointerdown',instantFocus,{passive:false});
  SEARCH_INPUT.addEventListener('touchstart',instantFocus,{passive:false});
  SEARCH_INPUT.addEventListener('click',()=>{ if(document.activeElement!==SEARCH_INPUT) SEARCH_INPUT.focus({preventScroll:true}); },{passive:true});
  SEARCH_INPUT.addEventListener('input',()=>{ rerenderSearch(); });
  SEARCH_INPUT.addEventListener('blur',()=>{ if(!MODAL_OPEN && SEARCH_INPUT.value.trim().length===0){ document.body.classList.remove('search-has-text'); clearSearchLayer(); } });

  // Bot√≥n ALEATORIO
  const randomBtn=document.getElementById('randomButton');
  randomBtn.addEventListener('click', async ()=>{
    if(randomBtn.dataset.busy==='1') return; randomBtn.dataset.busy='1';
    hideMsg();

    const layer=document.getElementById('searchResult');
    layer.style.display='none'; layer.innerHTML='';
    document.body.classList.add('search-has-text');

    if(!ALL || !Object.keys(ALL).length){
      const c=loadMapCache(); if(c?.freeList){ setAllFromFreeList(c.freeList); }
      else { await syncMapFast(); }
    }
    const libres=Object.keys(ALL||{}).filter(k=>ALL[k]==='libre');
    const chosen = libres.length ? libres[randInt(libres.length)] : String(randInt(10000)).padStart(4,'0');

    const placeholder=document.createElement('div'); placeholder.className='raffle large-raffle'; layer.appendChild(placeholder); layer.style.display='flex';

    await (async function playMagicBurst(container, duration=1000){
      if(!container || matchMedia('(prefers-reduced-motion: reduce)').matches) return;
      const oc=overlayCanvas(container); if(!oc) return;
      const {ctx,w,h,dpr,cleanup}=oc; const cx=w/2, cy=h/2;
      const colors=[[255,212,77],[0,255,169],[61,183,255],[255,255,255]];
      const N=Math.floor(Math.min(80,50+(w*h)/60000)); const parts=[];
      for(let i=0;i<N;i++){
        const ang=Math.random()*Math.PI*2, sp=(80+Math.random()*180)*dpr, r=(1.3+Math.random()*2)*dpr, col=colors[(Math.random()*colors.length)|0];
        parts.push({x:cx,y:cy,vx:Math.cos(ang)*sp,vy:Math.sin(ang)*sp,life:0,max:0.7+Math.random()*0.4,r,col});
      }
      ctx.globalCompositeOperation='lighter';
      await animateMs(duration,(p,dt)=>{
        ctx.clearRect(0,0,w,h);
        const ringR=(Math.max(w,h)*0.46)*Math.sin(p*Math.PI); const aR=(1-p)*0.85;
        ctx.lineWidth=Math.max(1,4.5*dpr*(1-p)); ctx.strokeStyle=rgba(255,212,77,aR); ctx.beginPath(); ctx.arc(cx,cy,Math.max(0,ringR*0.6),0,Math.PI*2); ctx.stroke();
        ctx.strokeStyle=rgba(0,255,169,aR*0.85); ctx.beginPath(); ctx.arc(cx,cy,Math.max(0,ringR*0.42),0,Math.PI*2); ctx.stroke();
        for(const pt of parts){
          pt.life+=dt; pt.vx*=(1-0.8*dt); pt.vy*=(1-0.8*dt); pt.vy+=240*dt*dpr*0.25; pt.x+=pt.vx*dt; pt.y+=pt.vy*dt;
          const a=Math.max(0,1-(pt.life/pt.max)); if(a<=0) continue;
          ctx.beginPath(); ctx.fillStyle=rgba(pt.col[0],pt.col[1],pt.col[2],a); ctx.arc(pt.x,pt.y,pt.r,0,Math.PI*2); ctx.fill();
        }
      });
      cleanup();
    })(placeholder, 1000);

    const st=ALL[chosen]||'ocupado'; SEARCH_INPUT.value=String(parseInt(chosen,10));
    layer.innerHTML='';
    if(st==='libre'){ renderSearchOne(chosen); } else { clearSearchLayer(); msg('Boleta ocupada', true); }
    randomBtn.dataset.busy='';
  },{passive:true});

  // Bot√≥n FINALIZAR (superior)
  const finishTopBtn = document.getElementById('finishTop');
  if(finishTopBtn){
    finishTopBtn.addEventListener('click',(e)=>{
      e.preventDefault();
      finalizeCart();
    });
  }

  

  // Checkout modal events
  const bd = document.getElementById('checkoutBackdrop');
  const closeBtn = document.getElementById('checkoutClose');
  const cancelBtn = document.getElementById('checkoutCancel');
  const submitBtn = document.getElementById('checkoutSubmit');
  const continueBtn = document.getElementById('loadingContinue');

  if(closeBtn) closeBtn.addEventListener('click', ()=>closeCheckoutModal());
  if(cancelBtn) cancelBtn.addEventListener('click', ()=>closeCheckoutModal());
  if(submitBtn) submitBtn.addEventListener('click', ()=>submitCheckout());
  if(continueBtn) continueBtn.addEventListener('click', ()=>{
    hideLoading();
    // Recarga completa para asegurar n√∫meros actualizados
    location.reload();
  });

  if(bd){
    bd.addEventListener('click',(e)=>{
      if(e.target === bd) closeCheckoutModal();
    });
  }

  // Enter para enviar
  const phoneEl = document.getElementById('checkoutPhone');
  const nameEl = document.getElementById('checkoutName');
  if(nameEl) nameEl.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ e.preventDefault(); submitCheckout(); }});
  if(phoneEl) phoneEl.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ e.preventDefault(); submitCheckout(); }});
// ARRANQUE EXPRESS (con boot)
  bootSet(60, 'Cargando boletas‚Ä¶', 'Usando cach√© para abrir ultra r√°pido');
  DAY_MARK=todayKey();

  const mcache=loadMapCache();
  if(mcache?.freeList){
    setAllFromFreeList(mcache.freeList);
    pickDaily(true);
    renderGrid();
    bootSet(82, 'Sincronizando disponibilidad‚Ä¶', 'Actualizando datos en segundo plano');
    if(mcache.stale){ (window.requestIdleCallback? requestIdleCallback(syncMapFast): setTimeout(syncMapFast,0)); }
    else setTimeout(syncMapFast, 1500);
  }else{
    const wrap=document.getElementById('raffles');
    const frag=document.createDocumentFragment();
    for(let i=0;i<24;i++){ const s=document.createElement('div'); s.className='raffle'; s.innerHTML='<span>----</span>'; frag.appendChild(s); }
    wrap.appendChild(frag);
    bootSet(72, 'Descargando disponibilidad‚Ä¶', 'Primera carga (solo esta vez)');
    await syncMapFast();
    pickDaily(true);
    renderGrid();
  }

  bootSet(95, 'Finalizando‚Ä¶', 'Todo listo');
  setTimeout(()=> bootHide(), 220);

  // Refrescos suaves
  GRID_TIMER=setInterval(()=>renderGrid(), 20000);
  MAP_TIMER=setInterval(async ()=>{
    const nowKey=todayKey();
    if(nowKey!==DAY_MARK){ DAY_MARK=nowKey; await syncMapFast(); DAILY=[]; pickDaily(true); renderGrid(); return; }
    const before=DAILY.length; await syncMapFast(); if(DAILY.length!==before){ renderGrid(); }
  }, 20000);
});
  </script>

  <!-- ====== CHECKOUT MODAL ====== -->
  <div id="checkoutBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="checkoutTitle">
    <div class="modal">
      <div class="modal-header">
        <h3 id="checkoutTitle">Finalizar compra</h3>
        <button id="checkoutClose" class="modal-close" type="button" aria-label="Cerrar">‚úï</button>
      </div>
      <div class="modal-body">
        <p id="checkoutSummary"></p>
        <div class="form-row">
          <label for="checkoutName">Nombre del participante</label>
          <input id="checkoutName" type="text" autocomplete="name" placeholder="Ej: Juan P√©rez" />
        </div>
        <div class="form-row">
          <label for="checkoutPhone">Tel√©fono (10 d√≠gitos)</label>
          <input id="checkoutPhone" type="tel" inputmode="numeric" autocomplete="tel" placeholder="Ej: 3001234567" />
          <div class="modal-small">Se guardar√° como 57XXXXXXXXXX.</div>
        </div>
      </div>
      <div class="modal-actions">
        <button id="checkoutCancel" class="btn btn-secondary" type="button">Cancelar</button>
        <button id="checkoutSubmit" class="btn btn-primary" type="button">Finalizar</button>
      </div>
    </div>
  </div>

  <!-- ====== LOADING / RESULT ====== -->
  <div id="loadingScreen" class="loading-screen" role="status" aria-live="polite">
    <div class="loading-card">
      <h4 id="loadingTitle">Registrando compra‚Ä¶</h4>
      <p id="loadingText">Por favor espera un momento.</p>
      <div style="height:14px"></div>
      <button id="loadingContinue" class="btn btn-primary" type="button" style="display:none">Seguir comprando</button>
    </div>
  </div>

</body>
</html>
